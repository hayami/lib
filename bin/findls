#!/bin/sh
set -e
umask 022
LANG=C
export LANG

nomd5=0
notime=0

usage() {
    echo "usage: findls [--no-md5] [--no-time] [dir ...]" 1>&2
    exit 1
}

while [ $# -gt 0 ]; do
    case "$1" in
    --no-md5|--nomd5)
        nomd5=1
        shift
        ;;
    --no-time|--notime)
        notime=1
        shift
        ;;
    *)
        break
        ;;
    esac
done

if [ $# -gt 0 ]; then
    for x in "$@"; do
        case "$x" in
        -*)
            usage
            ;;
        *)
            [ -e "$x" ] || usage
            ;;
        esac
    done
else
    set -- .
fi

find "$@" \
| sort -u \
| while read file; do
    ls -ld --time-style=full-iso "$file"
done \
| while read mode link user group size ymd hms off path; do
    if [ "$notime" -ne 0 ]; then
        ymd='0000-00-00'
        hms='00:00:00.000000000'
        off='+0000'
    fi
    md5='-'
    case "$mode" in
    d*|l*)
        ymd='0000-00-00'
        hms='00:00:00.000000000'
        off='+0000'
        ;;
    -*)
        if [ "$nomd5" -eq 0 ]; then
            md5=$(md5sum "$path")
            md5=${md5% *}
        fi
        ;;
    esac
    echo "$mode $user $group $size ${ymd}+${hms}$off $md5 $path"
done

exit 0
